name: 'Jira Webhook Direct'

on:
  repository_dispatch:
    types: [jira_trigger] # Debe coincidir con el event_type de Jira

permissions:
  contents: write # Necesario para crear carpetas

jobs:
  process_jira_webhook:
    runs-on: ubuntu-latest
    
    # 1. Define la clave de la incidencia como variable de entorno
    env:
      ISSUE_KEY: ${{ github.event.client_payload.issue_key }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      # 2. Ejecuta el script Bash para crear carpetas
      - name: Crear Carpeta CP y Carpeta de la Incidencia
        # El script crea CP/PROY-123 y exporta la ruta a $GITHUB_ENV como TARGET_DIR
        run: bash create_folders.sh "${{ env.ISSUE_KEY }}" 
      
      # 3. Configura el entorno Python (tu solicitud)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 4. Instala todas las dependencias (tu solicitud)
      - name: Install dependencies
        run: |
          pip install requests pypdf python-docx openai openpyxl
          
      # 5. Ejecuta el script principal de Python (Descarga + Procesamiento)
      - name: Ejecutar Descarga de Adjuntos
        run: python get_issue_attachments.py
        env:
          # Inyecta las credenciales de los Secrets de GitHub al entorno del script
          URL_JIRA: ${{ secrets.URL_JIRA_SECRET }} 
          USER_JIRA: ${{ secrets.USER_JIRA_SECRET }}
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN_SECRET }}
          
          # Inyecta la clave de la incidencia (de env) y la ruta dinámica (de $GITHUB_ENV)
          ISSUE_KEY: ${{ env.ISSUE_KEY }}
          TARGET_DIR: ${{ env.TARGET_DIR }} # <-- ¡Clave! Lee la ruta generada por el script Bash.